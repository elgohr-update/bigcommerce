FROM node:12

ARG COMMIT
ARG NPM_USER
ARG NPM_PASS
ARG NPM_EMAIL
ARG NPM_REGISTRY
ARG BIGCOMMERCE_API_CLIENT_ID
ARG BIGCOMMERCE_API_CLIENT_SECRET
ARG BIGCOMMERCE_API_URL
ARG BIGCOMMERCE_API_ACCESS_TOKEN
ARG BIGCOMMERCE_API_CLIENT_NAME
ARG BIGCOMMERCE_STOREFRONT_API_TOKEN
ARG BIGCOMMERCE_CHECKOUT_TYPE
ARG BIGCOMMERCE_PAYMENT_URL
ARG BIGCOMMERCE_CHANNEL_ID
ARG BIGCOMMERCE_STORE_ID

ENV LAST_COMMIT=${COMMIT}

RUN npm install -g npm-cli-login \
  && npm-cli-login

WORKDIR /var/www

COPY . .

RUN touch .env
RUN echo ${BIGCOMMERCE_API_CLIENT_ID}
RUN echo BIGCOMMERCE_API_CLIENT_ID =${BIGCOMMERCE_API_CLIENT_ID} >> .env
RUN echo BIGCOMMERCE_API_CLIENT_SECRET =${BIGCOMMERCE_API_CLIENT_SECRET} >> .env
RUN echo BIGCOMMERCE_API_URL =${BIGCOMMERCE_API_URL} >> .env
RUN echo BIGCOMMERCE_API_ACCESS_TOKEN =${BIGCOMMERCE_API_ACCESS_TOKEN} >> .env
RUN echo BIGCOMMERCE_API_CLIENT_NAME =${BIGCOMMERCE_API_CLIENT_NAME} >> .env
RUN echo BIGCOMMERCE_STOREFRONT_API_TOKEN =${BIGCOMMERCE_STOREFRONT_API_TOKEN} >> .env
RUN echo BIGCOMMERCE_CHECKOUT_TYPE =${BIGCOMMERCE_CHECKOUT_TYPE} >> .env
RUN echo BIGCOMMERCE_PAYMENT_URL =${BIGCOMMERCE_PAYMENT_URL} >> .env
RUN echo BIGCOMMERCE_CHANNEL_ID =${BIGCOMMERCE_CHANNEL_ID} >> .env
RUN echo BIGCOMMERCE_STORE_ID =${BIGCOMMERCE_STORE_ID} >> .env 

RUN yarn install --network-concurrency 1 && yarn build && yarn cache clean --all

COPY .vuestorefrontcloud/docker/vue-storefront.sh /usr/local/bin/

ENTRYPOINT ["vue-storefront.sh"]
